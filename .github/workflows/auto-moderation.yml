name: Auto Moderation Setup

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Reapply even if already processed"
        required: false
        default: "false"
      max_new:
        description: "Max subreddits to process this run"
        required: false
        default: "1"
  schedule:
    - cron: "0 9 * * *"  # daily at  1â€¯AM US Pacific Time

jobs:
  auto-setup:
    runs-on: ubuntu-latest
    concurrency:
      group: auto-moderation
      cancel-in-progress: false
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
      SUPABASE_COOKIES_ACCOUNT4_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT4_PATH }}
      SUPABASE_MODERATED_KNOWN_PATH: ${{ secrets.SUPABASE_MODERATED_KNOWN_PATH }}
      PYTHONPATH: src:.
      SELENIUM_USE_UNDETECTED: "0"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install matching ChromeDriver
        run: |
          set -euo pipefail
          VERSION="${CHROME_VERSION:-$(google-chrome --version | awk '{print $3}')}"
          BASE="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${VERSION}/linux64"
          URL="${BASE}/chromedriver-linux64.zip"
          echo "Downloading ChromeDriver ${VERSION} from ${URL}"
          curl -fSL "$URL" -o /tmp/chromedriver.zip
          unzip -o /tmp/chromedriver.zip -d /tmp
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate required secrets
        run: |
          set -euo pipefail
          for var in SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SUPABASE_BUCKET SUPABASE_COOKIES_ACCOUNT4_PATH SUPABASE_MODERATED_KNOWN_PATH; do
            if [ -z "${!var:-}" ]; then
              echo "Missing required secret: $var"
              exit 1
            fi
          done

      - name: Download account4 cookies from Supabase
        run: |
          set -euo pipefail
          mkdir -p data
          COOKIE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_COOKIES_ACCOUNT4_PATH}"
          curl -fsS -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
               -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
               -o data/cookies_account4.pkl \
               "$COOKIE_URL"

      - name: Download moderated_known cache from Supabase (if present)
        run: |
          set -euo pipefail
          mkdir -p data
          CACHE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_MODERATED_KNOWN_PATH}"
          echo "Fetching moderated_known.json from Supabase..."
          if curl -fSL -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
                      -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
                      -o data/moderated_known.json \
                      "$CACHE_URL"; then
            echo "Cache downloaded."
          else
            echo "No existing cache; starting fresh."
            echo '{"subreddits":[]}' > data/moderated_known.json
          fi

      - name: Run auto moderation setup (account4 only)
        run: |
          export CHROME_BIN="${CHROME_PATH:-/usr/bin/google-chrome}"
          export CHROMEDRIVER_PATH="${CHROMEDRIVER:-/usr/local/bin/chromedriver}"
          FORCE_FLAG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          MAX_NEW="${{ github.event.inputs.max_new }}"
          if [ -z "$MAX_NEW" ]; then MAX_NEW=1; fi
          python scripts/moderation/auto_setup.py --headless --max-new "$MAX_NEW" $FORCE_FLAG

      - name: Upload moderated_known cache to Supabase
        if: always()
        run: |
          set -euo pipefail
          if [ -f data/moderated_known.json ]; then
            CACHE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_MODERATED_KNOWN_PATH}"
            echo "Uploading moderated_known.json to Supabase..."
            curl -fSL -X PUT \
                 -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
                 -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
                 -H "Content-Type: application/json" \
                 --data-binary @data/moderated_known.json \
                 "$CACHE_URL"
          else
            echo "Cache file missing; nothing to upload."
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: auto-moderation-logs
          path: |
            logs/
            data/moderated_known.json
