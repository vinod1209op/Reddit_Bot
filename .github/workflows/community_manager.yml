name: Community Manager

on:
  workflow_dispatch:
    inputs:
      account:
        description: "Account name to run (account1/account2/account3)"
        required: false
        default: "account1"
      dry_run:
        description: "Run in dry-run mode"
        required: false
        default: "true"
      respect_windows:
        description: "Respect activity schedule time windows"
        required: false
        default: "true"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  community_manager:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - account: account1
          - account: account2
          - account: account3
    steps:
      - name: Gate run by schedule/account
        id: gate
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          DISPATCH_ACCOUNT: ${{ github.event.inputs.account }}
          MATRIX_ACCOUNT: ${{ matrix.account }}
        run: |
          should_run=false
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            if [ -z "$DISPATCH_ACCOUNT" ] || [ "$DISPATCH_ACCOUNT" = "$MATRIX_ACCOUNT" ]; then
              should_run=true
            fi
          elif [ "$EVENT_NAME" = "schedule" ]; then
            should_run=true
          fi
          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        if: steps.gate.outputs.should_run == 'true'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
        if: steps.gate.outputs.should_run == 'true'

      - name: Install Chrome and ChromeDriver
        if: steps.gate.outputs.should_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install

          CHROME_VERSION="$(google-chrome --version | awk '{print $3}')"
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

          echo "CHROME_BIN=$(command -v google-chrome)" >> $GITHUB_ENV
          echo "CHROMEDRIVER_PATH=/usr/local/bin/chromedriver" >> $GITHUB_ENV

      - name: Install Python dependencies
        if: steps.gate.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore cookie files (Supabase per-account)
        if: steps.gate.outputs.should_run == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_COOKIES_ACCOUNT1_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT1_PATH }}
          SUPABASE_COOKIES_ACCOUNT2_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT2_PATH }}
          SUPABASE_COOKIES_ACCOUNT3_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}
        run: |
          mkdir -p data
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_BUCKET:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "Supabase env missing; skipping cookie download."
            exit 0
          fi
          remote_path=""
          case "${{ matrix.account }}" in
            account1) remote_path="${SUPABASE_COOKIES_ACCOUNT1_PATH:-}" ;;
            account2) remote_path="${SUPABASE_COOKIES_ACCOUNT2_PATH:-}" ;;
            account3) remote_path="${SUPABASE_COOKIES_ACCOUNT3_PATH:-}" ;;
          esac
          if [ -z "$remote_path" ]; then
            echo "No per-account cookie path set for ${{ matrix.account }}; skipping download."
            exit 0
          fi
          url="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${remote_path#/}"
          curl -sS -X GET \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            "$url" \
            -o "data/cookies_${{ matrix.account }}.pkl"
          ls -la "data/cookies_${{ matrix.account }}.pkl"

      - name: Create minimal env file
        if: steps.gate.outputs.should_run == 'true'
        run: |
          mkdir -p config
          if [ ! -f config/credentials.env ]; then
            {
              echo "BOT_MODE=selenium"
              echo "ENABLE_POSTING=0"
              echo "USE_LLM=0"
            } > config/credentials.env
          fi

      - name: Run community manager
        if: steps.gate.outputs.should_run == 'true'
        env:
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SELENIUM_HEADLESS: "1"
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_ENVIRONMENT: "production"
        run: |
          set -euxo pipefail
          EVENT_NAME="${{ github.event_name }}"
          DRY_RUN_FLAG=""
          RESPECT_WINDOWS_FLAG=""
          if [ "$EVENT_NAME" = "schedule" ]; then
            DRY_RUN_FLAG="--dry-run"
          elif [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          if [ "${{ github.event.inputs.respect_windows }}" = "true" ]; then
            RESPECT_WINDOWS_FLAG="--respect-windows"
          fi
          python scripts/runners/community_manager.py \
            --account ${{ matrix.account }} \
            --headless \
            $DRY_RUN_FLAG \
            $RESPECT_WINDOWS_FLAG 2>&1 | tee logs/ci_community_manager.log
