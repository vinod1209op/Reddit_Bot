name: Reddit Humanized Scan

on:
  schedule:
    # Late night local time per account (UTC values; DST shifts may apply)
    - cron: "0 7 * * *"  # account1 (US Pacific ~23:00)
    - cron: "0 23 * * *" # account2 (UK ~23:00)
    - cron: "0 22 * * *" # account3 (DE ~23:00)
  workflow_dispatch:
    inputs:
      account:
        description: "Account name to run (default: account1)"
        required: false
        default: "account1"
      force_run:
        description: "Override schedule and run immediately (00:00-23:59)"
        required: false
        default: "false"
      windows:
        description: "Custom scan windows (HH:MM-HH:MM, comma-separated, no spaces). Overrides force_run if set."
        required: false
        default: ""

jobs:
  humanized_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        include:
          - account: account1
            cron: "0 7 * * *"
            tor_port: 9050
            tor_country: us
          - account: account2
            cron: "0 23 * * *"
            tor_port: 9051
            tor_country: gb
          - account: account3
            cron: "0 22 * * *"
            tor_port: 9052
            tor_country: de

    steps:
      - name: Gate run by schedule/account
        id: gate
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_SCHEDULE: ${{ github.event.schedule }}
          DISPATCH_ACCOUNT: ${{ github.event.inputs.account }}
          MATRIX_ACCOUNT: ${{ matrix.account }}
          MATRIX_CRON: ${{ matrix.cron }}
          PAUSE_SCHEDULED_RUNS: ${{ secrets.PAUSE_SCHEDULED_RUNS }}
        run: |
          should_run=false
          if [ "$PAUSE_SCHEDULED_RUNS" = "1" ]; then
            echo "Scheduled runs paused via PAUSE_SCHEDULED_RUNS=1"
            should_run=false
            echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            if [ -z "$DISPATCH_ACCOUNT" ] || [ "$DISPATCH_ACCOUNT" = "$MATRIX_ACCOUNT" ]; then
              should_run=true
            fi
          elif [ "$EVENT_NAME" = "schedule" ]; then
            if [ "$EVENT_SCHEDULE" = "$MATRIX_CRON" ]; then
              should_run=true
            fi
          fi
          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        if: steps.gate.outputs.should_run == 'true'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
        if: steps.gate.outputs.should_run == 'true'

      - name: Install Chrome and ChromeDriver
        if: steps.gate.outputs.should_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install

          CHROME_VERSION="$(google-chrome --version | awk '{print $3}')"
          echo "Chrome version: $CHROME_VERSION"

          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

          google-chrome --version
          /usr/local/bin/chromedriver --version

          echo "CHROME_BIN=$(command -v google-chrome)" >> $GITHUB_ENV
          echo "CHROMEDRIVER_PATH=/usr/local/bin/chromedriver" >> $GITHUB_ENV

      - name: Install Python dependencies
        if: steps.gate.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore cookie files
        if: steps.gate.outputs.should_run == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_COOKIES_PATH: ${{ secrets.SUPABASE_COOKIES_PATH }}
        run: |
          mkdir -p data
          python scripts/ops/supabase_cookies_sync.py download

      - name: Create minimal env file
        if: steps.gate.outputs.should_run == 'true'
        run: |
          mkdir -p config
          if [ ! -f config/credentials.env ]; then
            {
              echo "BOT_MODE=selenium"
              echo "ENABLE_POSTING=0"
              echo "USE_LLM=0"
            } > config/credentials.env
          fi

      - name: Setup Tor proxy
        if: steps.gate.outputs.should_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo service tor stop || true
          pkill -f tor || true
          PORT=${{ matrix.tor_port }}
          DATADIR="/tmp/tor_$PORT"
          mkdir -p "$DATADIR"
          chmod 700 "$DATADIR"
          cat > "$DATADIR/torrc" << EOF
          SocksPort 127.0.0.1:$PORT
          DataDirectory $DATADIR
          ControlPort $((PORT + 100))
          CookieAuthentication 1
          ExitNodes {${{ matrix.tor_country }}}
          StrictNodes 1
          EOF
          tor -f "$DATADIR/torrc" --RunAsDaemon 1
          sleep 8
          echo "üîç Checking Tor IP for ${{ matrix.account }} on port $PORT..."
          if curl --socks5-hostname 127.0.0.1:$PORT https://check.torproject.org/api/ip; then
            echo "Tor proxy test succeeded on port $PORT"
          else
            echo "Tor proxy test failed on port $PORT, continuing anyway"
          fi

      - name: Run humanized night scanner with Tor
        if: steps.gate.outputs.should_run == 'true'
        id: run_scan
        env:
          BOT_MODE: selenium
          ENABLE_POSTING: "0"
          USE_LLM: "0"
          LOG_LEVEL: "INFO"
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SELENIUM_HEADLESS: "1"
          SELENIUM_USE_UNDETECTED: "1"
          SELENIUM_STEALTH: "1"
          SELENIUM_RANDOMIZE_FINGERPRINT: "1"
          SELENIUM_CONTENT_TIMEOUT: "60"
          SELENIUM_CONTENT_ATTEMPTS: "1"
          SELENIUM_CONTENT_RETRY_DELAY: "1.0"
          SELENIUM_CLICK_ARTIFACTS: "1"
          USE_TOR_PROXY: "1"
          TOR_SOCKS_PORT: ${{ matrix.tor_port }}
          CI: "true"
          SCAN_LIMIT: "25"
          HUMANIZED_ACCOUNT_NAMES: ${{ github.event.inputs.account || matrix.account }}
        run: |
          set -euxo pipefail
          echo "Starting humanized scan..."
          mkdir -p logs
          WINDOWS_ARG=""
          if [ -n "${{ github.event.inputs.windows }}" ]; then
            WINDOWS_ARG="--windows ${{ github.event.inputs.windows }}"
          elif [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            WINDOWS_ARG="--force-run"
          fi
          python scripts/runners/humanized_night_scanner.py $WINDOWS_ARG 2>&1 | tee logs/ci_humanized_scan.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Flag ban/restriction signals (fail run)
        if: steps.gate.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          if [ ! -f logs/ci_humanized_scan.log ]; then
            echo "No ci_humanized_scan.log found; skipping ban signal scan."
            exit 0
          fi
          PATTERN="account suspended|account disabled|account locked|account restricted|you have been permanently banned|you have been temporarily banned|your account has been suspended|your account has been permanently suspended|your account has been temporarily suspended|suspicious activity|challenge|captcha_or_challenge_detected|login failed|cookie login verification failed"
          if rg -i "$PATTERN" logs/ci_humanized_scan.log; then
            echo "Ban/restriction signals detected in logs. Failing the run."
            exit 1
          fi

      - name: Email on failure (Outlook SMTP)
        if: failure() && steps.gate.outputs.should_run == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå Humanized scan failed (${{ matrix.account }})"
          body: "Check GitHub Actions logs for details."
          to: ${{ secrets.ALERT_EMAIL_TO }}
          from: Bot Alerts <${{ secrets.SMTP_USERNAME }}>
        continue-on-error: true
      
      - name: Upload refreshed cookies to Supabase
        if: always() && steps.gate.outputs.should_run == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_COOKIES_PATH: ${{ secrets.SUPABASE_COOKIES_PATH }}
        run: |
          python scripts/one_time/build_cookie_bundle.py --output data/cookies_bundle.zip
          python scripts/ops/supabase_cookies_sync.py upload

      - name: Upload logs to Supabase
        if: always() && steps.gate.outputs.should_run == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_PREFIX: scan-results/humanized
        run: |
          python scripts/ops/upload_logs_supabase.py

      - name: Upsert logs into Supabase DB
        if: always() && steps.gate.outputs.should_run == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_QUEUE_PATH: logs/night_queue.json
          SUPABASE_SUMMARY_PATH: logs/night_scan_summary.csv
        run: |
          python scripts/ops/upload_logs_supabase_db.py

      - name: Upload scan results
        if: always() && steps.gate.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: humanized-scan-results
          path: |
            logs/
            data/
          retention-days: 14

      - name: Fail workflow if scan failed
        if: steps.gate.outputs.should_run == 'true'
        run: |
          code="${{ steps.run_scan.outputs.exit_code }}"
          if [ -n "$code" ] && [ "$code" != "0" ]; then
            echo "Scan failed with exit code $code"
            exit "$code"
          fi

      - name: Check for suspended accounts
        if: always()  # Run even if previous steps fail
        run: |
          if grep -q "ACCOUNT SUSPENDED" ${{ github.workspace }}/logs/selenium_automation.log; then
            echo "üö® SUSPENDED ACCOUNT DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
            exit 1  # Fail the workflow (triggers GitHub notifications)
          fi
