name: Reddit Humanized Scan (account1)

on:
  schedule:
    # Late night local time per account (UTC values; DST shifts may apply)
    - cron: "0 7 * * *" # account1 (PT 23:00)
  workflow_dispatch: {}

jobs:
  humanized_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install

          CHROME_VERSION="$(google-chrome --version | awk '{print $3}')"
          echo "Chrome version: $CHROME_VERSION"

          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

          google-chrome --version
          /usr/local/bin/chromedriver --version

          echo "CHROME_BIN=$(command -v google-chrome)" >> $GITHUB_ENV
          echo "CHROMEDRIVER_PATH=/usr/local/bin/chromedriver" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore cookie files
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_COOKIES_ACCOUNT1_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT1_PATH }}
          SUPABASE_COOKIES_ACCOUNT2_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT2_PATH }}
          SUPABASE_COOKIES_ACCOUNT3_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}
        run: |
          mkdir -p data
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_BUCKET:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "Supabase env missing; skipping cookie download."
            exit 0
          fi
          remote_path="${SUPABASE_COOKIES_ACCOUNT1_PATH:-}"
          if [ -z "$remote_path" ]; then
            echo "No per-account cookie path set for account1; skipping download."
            exit 0
          fi
          url="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${remote_path#/}"
          curl -sS -X GET \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            "$url" \
            -o "data/cookies_account1.pkl"
          ls -la "data/cookies_account1.pkl"

      - name: Restore account_status.json
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_PREFIX: ${{ secrets.SUPABASE_PREFIX }}
        run: |
          mkdir -p data
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_BUCKET:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "Supabase env missing; skipping account status download."
            exit 0
          fi
          prefix="${SUPABASE_PREFIX:-scan-results/humanized}"
          status_path="${prefix%/}/account_status.json"
          url="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${status_path#/}"
          code="$(curl -s -o data/account_status.json -w "%{http_code}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            "$url")"
          if [ "$code" != "200" ]; then
            echo "No account_status.json found in Supabase (HTTP $code); continuing."
            rm -f data/account_status.json
            exit 0
          fi
          ls -la data/account_status.json

      - name: Restore account status from Supabase DB
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python scripts/ops/download_account_health_supabase_db.py

      - name: Check cookie envs (safe)
        run: |
          [ -n "${{ secrets.SUPABASE_URL }}" ] && echo "SUPABASE_URL set" || echo "SUPABASE_URL missing"
          [ -n "${{ secrets.SUPABASE_BUCKET }}" ] && echo "SUPABASE_BUCKET set" || echo "SUPABASE_BUCKET missing"
          [ -n "${{ secrets.SUPABASE_COOKIES_ACCOUNT1_PATH }}" ] && echo "COOKIES_ACCOUNT1_PATH set" || echo "COOKIES_ACCOUNT1_PATH missing"
          [ -n "${{ secrets.SUPABASE_COOKIES_ACCOUNT2_PATH }}" ] && echo "COOKIES_ACCOUNT2_PATH set" || echo "COOKIES_ACCOUNT2_PATH missing"
          [ -n "${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}" ] && echo "COOKIES_ACCOUNT3_PATH set" || echo "COOKIES_ACCOUNT3_PATH missing"

      - name: Create minimal env file
        run: |
          mkdir -p config
          if [ ! -f config/credentials.env ]; then
            {
              echo "BOT_MODE=selenium"
              echo "ENABLE_POSTING=0"
              echo "USE_LLM=0"
            } > config/credentials.env
          fi

      - name: Setup Tor proxy
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo systemctl stop tor || true
          sudo systemctl disable tor || true
          sudo service tor stop || true
          sudo pkill -f tor || true
          PORT=9050
          DATADIR="/tmp/tor_$PORT"
          mkdir -p "$DATADIR"
          chmod 700 "$DATADIR"
          cat > "$DATADIR/torrc" << EOF
          SocksPort 127.0.0.1:$PORT
          DataDirectory $DATADIR
          ControlPort $((PORT + 100))
          CookieAuthentication 1
          Log notice file $DATADIR/tor.log
          ExitNodes {us}
          StrictNodes 1
          EOF
          tor -f "$DATADIR/torrc" --RunAsDaemon 1
          for i in {1..60}; do
            if [ -f "$DATADIR/tor.log" ] && grep -q "Bootstrapped 100%" "$DATADIR/tor.log"; then
              echo "Tor bootstrapped."
              break
            fi
            sleep 1
          done
          echo "TOR_DATA_DIR=$DATADIR" >> "$GITHUB_ENV"
          echo "TOR_CONTROL_PORT=$((PORT + 100))" >> "$GITHUB_ENV"
          echo "üîç Checking Tor IP for account1 on port $PORT..."
          if curl --socks5-hostname 127.0.0.1:$PORT https://check.torproject.org/api/ip; then
            echo "Tor proxy test succeeded on port $PORT"
          else
            echo "Tor proxy test failed on port $PORT, continuing anyway"
          fi

      - name: Debug Tor rotation
        run: |
          set -euo pipefail
          if [ -z "${TOR_DATA_DIR:-}" ] || [ -z "${TOR_CONTROL_PORT:-}" ]; then
            echo "Tor control vars missing; skipping debug."
            exit 0
          fi
          PORT=9050
          echo "TOR_DATA_DIR=$TOR_DATA_DIR"
          echo "TOR_CONTROL_PORT=$TOR_CONTROL_PORT"
          echo "Checking Tor IP on port $PORT..."
          ip_info="$(curl --socks5-hostname 127.0.0.1:$PORT -sS https://check.torproject.org/api/ip || true)"
          echo "Tor IP Info: $ip_info"
          echo "Checking control port $TOR_CONTROL_PORT..."
          nc -z 127.0.0.1 "$TOR_CONTROL_PORT" && echo "Control port OPEN" || echo "Control port CLOSED"
          COOKIE_FILE="/tmp/tor_$PORT/control_auth_cookie"
          ls -la $COOKIE_FILE || echo "No cookie file"

      - name: Rotate Tor circuit (NEWNYM)
        run: |
          set -euo pipefail
          if [ -z "${TOR_DATA_DIR:-}" ] || [ -z "${TOR_CONTROL_PORT:-}" ]; then
            echo "Tor control vars missing; skipping NEWNYM."
            exit 0
          fi
          PORT=9050
          echo "Checking Tor IP before NEWNYM on port $PORT..."
          before_ip="$(curl --socks5-hostname 127.0.0.1:$PORT -sS https://check.torproject.org/api/ip || true)"
          echo "Before: ${before_ip:-<unavailable>}"
          cookie_file="$TOR_DATA_DIR/control_auth_cookie"
          if [ ! -f "$cookie_file" ]; then
            echo "Tor control cookie not found at $cookie_file; skipping NEWNYM."
            exit 0
          fi
          cookie_hex="$(hexdump -v -e '/1 "%02x"' "$cookie_file")"
          printf 'AUTHENTICATE %s\r\nSIGNAL NEWNYM\r\nQUIT\r\n' "$cookie_hex" | nc 127.0.0.1 "$TOR_CONTROL_PORT"
          sleep 5
          after_ip="$(curl --socks5-hostname 127.0.0.1:$PORT -sS https://check.torproject.org/api/ip || true)"
          echo "After: ${after_ip:-<unavailable>}"
          echo "Tor NEWNYM sent on control port $TOR_CONTROL_PORT"

      - name: Run humanized night scanner with Tor
        id: run_scan
        env:
          BOT_MODE: selenium
          ENABLE_POSTING: "0"
          USE_LLM: "0"
          LOG_LEVEL: "INFO"
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SELENIUM_HEADLESS: "1"
          SELENIUM_USE_UNDETECTED: "1"
          SELENIUM_STEALTH: "1"
          SELENIUM_RANDOMIZE_FINGERPRINT: "1"
          SELENIUM_CONTENT_TIMEOUT: "60"
          SELENIUM_CONTENT_ATTEMPTS: "1"
          SELENIUM_CONTENT_RETRY_DELAY: "1.0"
          SELENIUM_CLICK_ARTIFACTS: "1"
          USE_TOR_PROXY: "1"
          TOR_SOCKS_PORT: "9050"
          CI: "true"
          SCAN_LIMIT: "25"
          HUMANIZED_ACCOUNT_NAMES: account1
        run: |
          set -euxo pipefail
          echo "Starting humanized scan..."
          mkdir -p logs
          WINDOWS_ARG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            WINDOWS_ARG="--force-run"
          fi
          python scripts/runners/humanized_night_scanner.py $WINDOWS_ARG 2>&1 | tee logs/ci_humanized_scan.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Flag ban/restriction signals (fail run)
        run: |
          set -euo pipefail
          if [ ! -f logs/ci_humanized_scan.log ]; then
            echo "No ci_humanized_scan.log found; skipping ban signal scan."
            exit 0
          fi
          PATTERN="account suspended|account disabled|account locked|account restricted|you have been permanently banned|you have been temporarily banned|your account has been suspended|your account has been permanently suspended|your account has been temporarily suspended|suspicious activity|login failed|cookie login verification failed"
          if grep -Eqi "$PATTERN" logs/ci_humanized_scan.log; then
            echo "Ban/restriction signals detected in logs." | tee -a logs/ban_alert.log
            exit 1
          fi

      - name: Email on failure (Outlook SMTP)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå Humanized scan failed (account1)"
          body: "Check GitHub Actions logs for details."
          to: ${{ secrets.ALERT_EMAIL_TO }}
          from: Bot Alerts <${{ secrets.SMTP_USERNAME }}>
        continue-on-error: true
      
      - name: Upload per-account cookies to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_COOKIES_ACCOUNT1_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT1_PATH }}
          SUPABASE_COOKIES_ACCOUNT2_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT2_PATH }}
          SUPABASE_COOKIES_ACCOUNT3_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}
        run: |
          set -euo pipefail
          remote_path="${SUPABASE_COOKIES_ACCOUNT1_PATH:-}"
          local_file="data/cookies_account1.pkl"
          if [ -z "$remote_path" ]; then
            echo "No per-account cookie path set for account1; skipping upload."
            exit 0
          fi
          if [ ! -f "$local_file" ]; then
            echo "$local_file not found; skipping upload."
            exit 0
          fi
          curl -sS -X PUT \
            "${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${remote_path#/}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/octet-stream" \
            -H "x-upsert: true" \
            --data-binary @"$local_file" \
            && echo "Uploaded cookies for account1."

      - name: Upsert logs into Supabase DB
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_QUEUE_PATH: logs/night_queue.json
          SUPABASE_SUMMARY_PATH: logs/night_scan_summary.csv
        run: |
          python scripts/ops/upload_logs_supabase_db.py

      - name: Supabase DB sanity check
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "${SUPABASE_URL:-}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "Supabase env missing; skipping DB sanity check."
            exit 0
          fi
          url="${SUPABASE_URL%/}/rest/v1/account_health?select=account_name&limit=1"
          code="$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            "$url")"
          if [ "$code" != "200" ]; then
            echo "Supabase DB sanity check failed (HTTP $code)."
          else
            echo "Supabase DB sanity check OK."
          fi

      - name: Upsert account health into Supabase DB
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python scripts/ops/upload_account_health_supabase_db.py

      - name: Upload logs to Supabase
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
          SUPABASE_PREFIX: ${{ secrets.SUPABASE_PREFIX }}
        run: |
          python scripts/ops/upload_logs_supabase.py

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: humanized-scan-results
          path: |
            logs/
            data/
          retention-days: 14

      - name: Fail workflow if scan failed
        run: |
          code="${{ steps.run_scan.outputs.exit_code }}"
          if [ -n "$code" ] && [ "$code" != "0" ]; then
            echo "Scan failed with exit code $code"
            exit "$code"
          fi

      - name: Check for suspended accounts
        if: always()  # Run even if previous steps fail
        run: |
          if grep -q "ACCOUNT SUSPENDED" ${{ github.workspace }}/logs/selenium_automation.log; then
            echo "üö® SUSPENDED ACCOUNT DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
            exit 1  # Fail the workflow (triggers GitHub notifications)
          fi
