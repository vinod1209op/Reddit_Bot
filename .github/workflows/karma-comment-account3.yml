name: Karma Comment (account3)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"
    - cron: "0 9 * * *"
    - cron: "0 17 * * *"

jobs:
  karma-comment:
    runs-on: ubuntu-latest
    concurrency:
      group: karma-comment-account3
      cancel-in-progress: false
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
      SUPABASE_POST_SCHEDULE_PATH: ${{ secrets.SUPABASE_POST_SCHEDULE_PATH }}
      SUPABASE_COOKIES_ACCOUNT3_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}
      PYTHONPATH: ${{ github.workspace }}:src:.
      SELENIUM_USE_UNDETECTED: "0"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install matching ChromeDriver
        run: |
          set -euo pipefail
          VERSION="${CHROME_VERSION:-$(google-chrome --version | awk '{print $3}')}"
          BASE="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${VERSION}/linux64"
          URL="${BASE}/chromedriver-linux64.zip"
          curl -fSL "$URL" -o /tmp/chromedriver.zip
          unzip -o /tmp/chromedriver.zip -d /tmp
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download account3 cookies from Supabase
        run: |
          set -euo pipefail
          mkdir -p data
          COOKIE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_COOKIES_ACCOUNT3_PATH}"
          curl -fsS -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
               -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
               -o data/cookies_account3.pkl \
               "$COOKIE_URL"

      - name: Random jitter (0-120 minutes, skip on manual)
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run: skipping jitter."
            exit 0
          fi
          python - <<'PY'
          import random, time
          seconds = random.randint(0, 120 * 60)
          print(f"Jitter sleep: {seconds//60} minutes")
          time.sleep(seconds)
          PY

      - name: Load subreddit list
        id: subs
        run: |
          python - <<'PY'
          import json, pathlib
          subs = json.loads(pathlib.Path("config/subreddits.json").read_text())
          if isinstance(subs, dict):
            subs = subs.get("subreddits") or subs.get("list") or []
          subs = [s for s in subs if isinstance(s, str)]
          print(f"SUBS={' '.join(subs)}")
          with open("$GITHUB_OUTPUT", "a") as f:
            f.write(f"subs={' '.join(subs)}\n")
          PY

      - name: Run karma comment (account3)
        run: |
          export CHROME_BIN="${CHROME_PATH:-/usr/bin/google-chrome}"
          export CHROMEDRIVER_PATH="${CHROMEDRIVER:-/usr/local/bin/chromedriver}"
          python scripts/engagement/reply_queue_runner.py \
            --account account3 \
            --role generate \
            --count 1 \
            --headless \
            --post \
            --use-llm \
            --force \
            --supabase-prefix "${SUPABASE_POST_SCHEDULE_PATH%/}" \
            --subreddits ${{ steps.subs.outputs.subs }}
