name: Reddit Selenium Read-Only Scan

on:
  schedule:
    # 02:00 and 23:00 America/Los_Angeles (UTC offsets vary with DST)
    - cron: "0 10 * * *"
    - cron: "0 7 * * *"
  workflow_dispatch:
    inputs:
      force_run:
        description: "Override schedule and run immediately (00:00-23:59)"
        required: false
        default: "false"
      windows:
        description: "Custom scan windows (HH:MM-HH:MM, comma-separated, no spaces). Overrides force_run if set."
        required: false
        default: ""

jobs:
  selenium_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium chromium-driver

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-selenium.txt

      - name: Restore cookie file
        env:
          REDDIT_COOKIES_BASE64: ${{ secrets.REDDIT_COOKIES_BASE64 }}
        run: |
          if [ -z "$REDDIT_COOKIES_BASE64" ]; then
            echo "Missing REDDIT_COOKIES_BASE64 secret" >&2
            exit 1
          fi
          mkdir -p data
          echo "$REDDIT_COOKIES_BASE64" | base64 -d > data/gha_cookies.pkl

      - name: Run night scanner (read-only)
        env:
          BOT_MODE: selenium
          ENABLE_POSTING: "0"
          USE_LLM: "0"
          SELENIUM_HEADLESS: "1"
          SELENIUM_USE_UNDETECTED: "0"
          SELENIUM_STEALTH: "0"
          SELENIUM_RANDOMIZE_FINGERPRINT: "0"
          CHROME_BIN: /usr/bin/chromium
          CHROMEDRIVER_PATH: /usr/bin/chromedriver
          COOKIE_PATH: data/gha_cookies.pkl
        run: |
          RUN_WINDOWS=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            WINDOWS_INPUT="${{ github.event.inputs.windows }}"
            WINDOWS_INPUT="${WINDOWS_INPUT// /}"
            if [ -n "$WINDOWS_INPUT" ]; then
              RUN_WINDOWS="--windows $WINDOWS_INPUT"
            elif [ "${{ github.event.inputs.force_run }}" = "true" ]; then
              RUN_WINDOWS="--windows 00:00-23:59"
            fi
          fi
          python scripts/night_scanner.py --mode selenium --schedule-path config/schedule.json $RUN_WINDOWS

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            logs/
            data/
          retention-days: 14
