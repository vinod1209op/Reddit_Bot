name: Reddit Selenium Read-Only Scan

on:
  schedule:
    # 02:00 and 23:00 America/Los_Angeles (UTC offsets vary with DST)
    - cron: "0 10 * * *"
    - cron: "0 7 * * *"
  workflow_dispatch:
    inputs:
      force_run:
        description: "Override schedule and run immediately (00:00-23:59)"
        required: false
        default: "false"
      windows:
        description: "Custom scan windows (HH:MM-HH:MM, comma-separated, no spaces). Overrides force_run if set."
        required: false
        default: ""

jobs:
  selenium_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install

          CHROME_VERSION="$(google-chrome --version | awk '{print $3}')"
          echo "Chrome version: $CHROME_VERSION"

          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

          google-chrome --version
          /usr/local/bin/chromedriver --version

          echo "CHROME_BIN=$(command -v google-chrome)" >> $GITHUB_ENV
          echo "CHROMEDRIVER_PATH=/usr/local/bin/chromedriver" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-selenium.txt

      - name: Restore cookie file
        env:
          REDDIT_COOKIES_BASE64: ${{ secrets.REDDIT_COOKIES_BASE64 }}
        run: |
          if [ -z "$REDDIT_COOKIES_BASE64" ]; then
            echo "Missing REDDIT_COOKIES_BASE64 secret" >&2
            exit 1
          fi
          mkdir -p data
          echo "$REDDIT_COOKIES_BASE64" | base64 -d > data/gha_cookies.pkl

      - name: Create minimal env file
        run: |
          mkdir -p config
          if [ ! -f config/credentials.env ]; then
            {
              echo "BOT_MODE=selenium"
              echo "ENABLE_POSTING=0"
              echo "USE_LLM=0"
            } > config/credentials.env
          fi

      - name: Setup Tor proxy
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo service tor start
          for i in {1..15}; do
            if systemctl is-active --quiet tor; then
              echo "Tor service is active"
              break
            fi
            echo "Waiting for Tor service ($i/15)..."
            sleep 2
          done
          if ! systemctl is-active --quiet tor; then
            echo "Tor service did not become active in time" >&2
          fi
          if curl --socks5 127.0.0.1:9050 http://httpbin.org/ip; then
            echo "Tor proxy test succeeded"
          else
            echo "Tor proxy test failed, continuing anyway"
          fi

      - name: Run night scanner with Tor
        env:
          BOT_MODE: selenium
          ENABLE_POSTING: "0"
          USE_LLM: "0"
          SELENIUM_HEADLESS: "1"
          SELENIUM_USE_UNDETECTED: "1"
          SELENIUM_STEALTH: "1"
          SELENIUM_RANDOMIZE_FINGERPRINT: "1"
          SELENIUM_CONTENT_TIMEOUT: "60"
          SELENIUM_CONTENT_ATTEMPTS: "1"
          SELENIUM_CONTENT_RETRY_DELAY: "1.0"
          USE_TOR_PROXY: "1"
          CI: "true"
          SCAN_LIMIT: "3"
          SCAN_MAX_SUBREDDITS: "2"
        run: |
          echo "Starting Tor-based scan..."
          python scripts/night_scanner.py \
            --mode selenium \
            --limit 3 \
            --max-subreddits 2 \
            --jitter-min 10 \
            --jitter-max 20

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            logs/
            data/
          retention-days: 14
