name: Simple Template Posting (account3)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *"  # 09:00 UTC (10:00 CET-1)

jobs:
  simple-posting:
    runs-on: ubuntu-latest
    concurrency:
      group: simple-posting-account3
      cancel-in-progress: false
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
      SUPABASE_POST_SCHEDULE_PATH: ${{ secrets.SUPABASE_POST_SCHEDULE_PATH }}
      SUPABASE_COOKIES_ACCOUNT3_PATH: ${{ secrets.SUPABASE_COOKIES_ACCOUNT3_PATH }}
      PYTHONPATH: ${{ github.workspace }}:src:.
      SELENIUM_USE_UNDETECTED: "0"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init dirs
        run: |
          mkdir -p logs scripts/content_scheduling/schedule
          touch scripts/content_scheduling/schedule/post_schedule.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install matching ChromeDriver
        run: |
          set -euo pipefail
          VERSION="${CHROME_VERSION:-$(google-chrome --version | awk '{print $3}')}"
          BASE="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${VERSION}/linux64"
          URL="${BASE}/chromedriver-linux64.zip"
          echo "Downloading ChromeDriver ${VERSION} from ${URL}"
          curl -fSL "$URL" -o /tmp/chromedriver.zip
          unzip -o /tmp/chromedriver.zip -d /tmp
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Tor proxy
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo systemctl stop tor || true
          sudo systemctl disable tor || true
          sudo service tor stop || true
          sudo pkill -f tor || true
          PORT=9051
          DATADIR="/tmp/tor_$PORT"
          mkdir -p "$DATADIR"
          chmod 700 "$DATADIR"
          cat > "$DATADIR/torrc" << EOF
          SocksPort 127.0.0.1:$PORT
          DataDirectory $DATADIR
          ControlPort $((PORT + 100))
          CookieAuthentication 1
          Log notice file $DATADIR/tor.log
          ExitNodes {gb}
          StrictNodes 1
          EOF
          tor -f "$DATADIR/torrc" --RunAsDaemon 1
          for i in {1..60}; do
            if [ -f "$DATADIR/tor.log" ] && grep -q "Bootstrapped 100%" "$DATADIR/tor.log"; then
              echo "Tor bootstrapped."
              break
            fi
            sleep 1
          done
          echo "TOR_DATA_DIR=$DATADIR" >> "$GITHUB_ENV"
          echo "TOR_SOCKS_PORT=$PORT" >> "$GITHUB_ENV"
          echo "TOR_CONTROL_PORT=$((PORT + 100))" >> "$GITHUB_ENV"
          curl --socks5-hostname 127.0.0.1:$PORT https://check.torproject.org/api/ip || true

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -n "${SUPABASE_COOKIES_ACCOUNT3:-}" ] && [ -z "${SUPABASE_COOKIES_ACCOUNT3_PATH:-}" ]; then
            echo "SUPABASE_COOKIES_ACCOUNT3_PATH=${SUPABASE_COOKIES_ACCOUNT3}" >> "$GITHUB_ENV"
          fi
          if [ -n "${COOKIES_ACCOUNT3_PATH:-}" ] && [ -z "${SUPABASE_COOKIES_ACCOUNT3_PATH:-}" ]; then
            echo "SUPABASE_COOKIES_ACCOUNT3_PATH=${COOKIES_ACCOUNT3_PATH}" >> "$GITHUB_ENV"
          fi
          for var in SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SUPABASE_BUCKET SUPABASE_POST_SCHEDULE_PATH SUPABASE_COOKIES_ACCOUNT3_PATH; do
            if [ -z "${!var:-}" ]; then
              echo "Missing required secret: $var"
              exit 1
            fi
          done

      - name: Download account3 cookies from Supabase
        run: |
          set -euo pipefail
          mkdir -p data
          COOKIE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_COOKIES_ACCOUNT3_PATH}"
          curl -fsS -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
               -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
               -o data/cookies_account3.pkl \
               "$COOKIE_URL"

      - name: Download post schedule from Supabase (shared)
        run: |
          set -euo pipefail
          mkdir -p scripts/content_scheduling/schedule
          SCHEDULE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_POST_SCHEDULE_PATH%/}/post_schedule.json"
          if curl -fSL -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
                      -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
                      -o scripts/content_scheduling/schedule/post_schedule.json \
                      "$SCHEDULE_URL"; then
            echo "Schedule downloaded."
          else
            echo "No existing schedule; starting fresh."
            echo "[]" > scripts/content_scheduling/schedule/post_schedule.json
          fi

      - name: Run simple posting (templates only)
        env:
          USE_TOR_PROXY: "1"
          TOR_SOCKS_PORT: "9051"
          FORCE_DUE: ${{ github.event_name == 'workflow_dispatch' && '1' || '0' }}
        run: |
          export CHROME_BIN="${CHROME_PATH:-/usr/bin/google-chrome}"
          export CHROMEDRIVER_PATH="${CHROMEDRIVER:-/usr/local/bin/chromedriver}"
          FORCE_FLAG=""
          if [ "${FORCE_DUE:-0}" = "1" ]; then
            FORCE_FLAG="--force-due"
          fi
          python scripts/content_scheduling/simple_posting.py --accounts account3 --headless --target 6 --days 3 --supabase-prefix "${SUPABASE_POST_SCHEDULE_PATH%/}" --shared-schedule $FORCE_FLAG

      - name: Upload post schedule to Supabase (shared)
        if: always()
        run: |
          set -euo pipefail
          if [ -f scripts/content_scheduling/schedule/post_schedule.json ]; then
            SCHEDULE_URL="${SUPABASE_URL%/}/storage/v1/object/${SUPABASE_BUCKET}/${SUPABASE_POST_SCHEDULE_PATH%/}/post_schedule.json"
            curl -fSL -X PUT \
                 -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
                 -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
                 -H "Content-Type: application/json" \
                 --data-binary @scripts/content_scheduling/schedule/post_schedule.json \
                 "$SCHEDULE_URL"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: simple-posting-logs-account3-${{ github.run_attempt }}
          path: |
            logs/
            scripts/content_scheduling/schedule/post_schedule.json
